<!DOCTYPE html>
<html lang="it">

<head>
    <title>ThePrivilege employee stuff</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--Stylesheet -->
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Awesome CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Richiesta Api dal backend -->
    <script src="https://site202120.tw.cs.unibo.it/assets/config.js"></script>
    <script src="https://site202120.tw.cs.unibo.it/assets/api.js"></script>

    <!-- Funzioni di supporto -->
    <script src="../../js/function.js"></script>


    <script>
        $.get('../templates/authNav.html', (data) => {
            $('body').append(data)
        })
    </script>

    <script>
        checkToken()
    </script>

</head>

<!-- TODO: Rivedere la grafica e la formattazione delle date nella card dei rent -->

<body>
    <div id="content" class="row d-flex justify-content-center">
        <div class="d-flex justify-content-center">
            <h1>Informazioni sul cliente</h1>
        </div>

        <div class="card col-sm-8 p-4">
            <div class="row d-flex justify-content-center">
                <div class="row col-sm-6">
                    <img id="profilepicture" class="img-fluid rounded" alt="Immagine profilo del cliente"
                        style="object-fit: scale-down;">
                    <textarea id="description" class="form-control input-card mt-4" disabled="disabled"></textarea>
                </div>

                <div class="col-sm-6 d-flex justify-content-center">
                    <form id="customerInfo" class="w-100">
                        <label for="username">Username</label><br>
                        <input id="username" class="form-control input-card title" disabled="disabled"><br>
                        <label for="firstname">Nome</label><br>
                        <input id="firstname" class="form-control input-card title" disabled="disabled"><br>
                        <label for="lastname">Cognome</label><br>
                        <input id="lastname" class="form-control input-card title" disabled="disabled"><br>
                        <label for="dateOfBirth">Data di nascita</label><br>
                        <input id="dateOfBirth" type="date" class="form-control input-card title" disabled="disabled"><br>
                        <label for="country">Paese</label><br>
                        <input id="country" class="form-control input-card title" disabled="disabled"><br>
                        <label for="city">Città</label><br>
                        <input id="city" class="form-control input-card title" disabled="disabled"><br>
                        <label for="streetAddress">Indirizzo</label><br>
                        <input id="streetAddress" class="form-control input-card title" disabled="disabled"><br>
                        <label for="zipcode">Codice postale</label><br>
                        <input id="zipcode" class="form-control input-card title" disabled="disabled"><br>
                    </form>
                </div>

            </div>

            <div id="buttonPanel" class="d-flex justify-content-around mt-3">
                <button type="button" class="btn btn-search" id="modify">Modify</button>
                <div id="wrapperdelete" data-toggle="tooltip"
                    title="Non è possibile eliminare un cliente che ha noleggi aperti o chiusi">
                    <button type="button" class="btn btn-search" id="delete">Delete</button>
                </div>
                <button type="button" class="btn btn-search" id="submit">Submit</button>
            </div>
        </div>

        <!-- Informazioni sui noleggi -->
        <div id="rentInfo" class="mt-5">
            <div class="d-flex justify-content-center">
                <h1>Noleggi in attesa di conferma</h1>
            </div>
            <div id="pendingRent" class="row"></div>

            <div class="d-flex justify-content-center">
                <h1>Noleggi aperti</h1>
            </div>
            <div id="openRent" class="row"></div>

            <div class="d-flex justify-content-center">
                <h1>Noleggi conclusi</h1>
            </div>
            <div id="closeRent" class="row"></div>
        </div>
    </div>
</body>

<footer>
    <script>
        const idCustomer = localStorage.getItem('CustomerID')
        let customer
        let rentals
        let state = true
        //TODO: Da sistemare partire sempre dall'oggetto restituito dal server
        function getFormCustomer() {
            let newCustomer = {
                firstname: $('#firstname').val(),
                lastname: $('#lastname').val(),
                dateOfBirth: $('#dateOfBirth').val(),
                loginInfo: customer.loginInfo,
                address: {
                    city: $('#city').val(),
                    country: $('#country').val(),
                    streetAddress: $('#streetAddress').val(),
                    zipcode: $('#zipcode').val(),
                },
                description: $('#description').val() || "",
                profilePicture: "image/profile/placeholder.png",
                _id: customer._id
            }
            console.log(newCustomer)
            return newCustomer
        }

        function addSubmit() {
            $('#buttonPanel').append(`
            <button id="submit" class="btn btn-warning>Submit</button>
            `)
        }

        $('document').ready(async () => {
            customer = (await api.customers.getSingle(idCustomer)).data
            console.log(customer)

            //Aggiungo le info come placeholder del form
            $('#username').attr('value', `${customer.loginInfo.username}`)
            $('#firstname').attr('value', `${customer.firstname}`)
            $('#lastname').attr('value', `${customer.lastname}`)
            $('#dateOfBirth').attr('value', `${(customer.dateOfBirth).toString().slice(0, 10)}`)
            $('#country').attr('value', `${customer.address.country}`)
            $('#city').attr('value', `${customer.address.city}`)
            $('#streetAddress').attr('value', `${customer.address.streetAddress}`)
            $('#zipcode').attr('value', `${customer.address.zipcode}`)

            //Aggiungo altre informazioni dell'utente
            $('#profilepicture').attr('src', `https://site202120.tw.cs.unibo.it/${customer.profilePicture}`)
            $('#description').val(customer.description)

            //Prendo le rent
            let query = { populate: true }
            rentals = (await api.customers.getRentals(idCustomer, query)).data.docs
            console.log(rentals)

            //Le divido in base allo state 
            let pendingRentals = []
            let openRentals = []
            let closeRentals = []

            rentals.forEach(rent => {
                if (rent.state == 'pending')
                    pendingRentals.push(rent)
                if (rent.state == 'open')
                    openRentals.push(rent)
                if (rent.state == 'close')
                    closeRentals.push(rent)
            });

            //Se il cliente ha noleggi attivi o conclusi non può essere cancellato
            if (openRentals.length > 0 || closeRentals.length > 0) { $('#delete').addClass('disabled') }

            //Appendo i vari rent in base allo stato
            if (pendingRentals.length != 0) {
                pendingRentals.forEach(rent => {
                    $('#pendingRent').append(`
                <div class="card col-sm-3 mt-4 me-4 p-3" onclick="rentalPage('${rent._id}')">    
                    <h5 class="card-title">Noleggio in attesa di ${rent.unit.name}</h5>
                    <p class="card-text">Il Noleggio dovrebbe partire il ${(rent.startDate).toString().slice(0, 10)}</p>
                </div>
                `)
                })
            }
            else {
                $('#pendingRent').append(`
                <div class="d-flex justify-content-center">
                <div class="card col-sm-8 ps-4">
                    <h1>Non ci sono noleggi in attesa</h1>
                </div> 
                </div>
                `)
            }


            if (openRentals.length != 0) {
                openRentals.forEach(rent => {
                    $('#openRent').append(`
                    <div class="card col-sm-3 mt-4 me-4 p-3" onclick="rentalPage('${rent._id}')">
                        <h5 class="card-title">Rent aperto di ${rent.unit.name}</h5>
                        <p class="card-text">Il Noleggio è iniziato ${(rent.startDate).toString().slice(0, 10)}</p>
                        <p class="card-text">E dovrebbe finire ${(rent.expectedEndDate).toString().slice(0, 10)}</p>
                    </div>
                    `)
                })
            }
            else {
                $('#openRent').append(`
                <div class="d-flex justify-content-center">
                <div class="card col-sm-8 ps-4">
                    <h1>Non ci sono noleggi in aperti</h1>
                </div> 
                </div>
                `)
            }

            if (closeRentals.length != 0) {
                closeRentals.forEach(rent => {
                    $('#closeRent').append(`
                    <div class="card col-sm-3 mt-4 me-4 p-3 mb-4" onclick="rentalPage('${rent._id}')">
                        <h5 class="card-title">Rent chiuso di ${rent.unit.name}</h5>
                        <p class="card-text">Il Noleggio è iniziato ${(rent.startDate).toString().slice(0, 16)}</p>
                        <p class="card-text">Il termine del noleggio era previsto per ${(rent.expectedEndDate).toString().slice(0, 10)}</p>
                        <p class="card-text">La consegna è effettivamente avvenuta ${(rent.endDate).toString().slice(0, 10)}</p>
                    </div>
                `)
                })
            }
            else {
                $('#closeRent').append(`
                <div class="d-flex justify-content-center mb-4">
                    <div class="card col-sm-8 ps-4">
                        <h1>Non ci sono noleggi conclusi</h1>
                    </div> 
                </div>
                `)
            }
        })

        $('#modify').click(async () => {
            if (state) {
                $('#firstname').removeAttr('disabled')
                $('#lastname').removeAttr('disabled')
                $('#dateOfBirth').removeAttr('disabled')
                $('#country').removeAttr('disabled')
                $('#city').removeAttr('disabled')
                $('#streetAddress').removeAttr('disabled')
                $('#zipcode').removeAttr('disabled')
                $('#description').removeAttr('disabled')

                state = false
            }
            else {
                $('#firstname').attr('disabled', 'disabled')
                $('#lastname').attr('disabled', 'disabled')
                $('#dateOfBirth').attr('disabled', 'disabled')
                $('#country').attr('disabled', 'disabled')
                $('#city').attr('disabled', 'disabled')
                $('#streetAddress').attr('disabled', 'disabled')
                $('#zipcode').attr('disabled', 'disabled')
                $('#description').attr('disabled', 'disabled')

                state = true
            }
        })

        $('#delete').on('click', async (event) => {
            event.preventDefault()
            const response = await api.customers.deleteSingle(customer._id, getFormCustomer())
        })

        $('#submit').on('click', async (event) => {
            event.preventDefault()
            const response = (await api.customers.patchSingle(customer._id, getFormCustomer())).data
        })
    </script>
</footer>

</html>