<!DOCTYPE html>
<html lang="it">

<head>
    <title>ThePrivilege employee stuff</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--Stylesheet -->
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Awesome CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Richiesta Api dal backend -->
    <script src="https://site202120.tw.cs.unibo.it/assets/config.js"></script>
    <script src="https://site202120.tw.cs.unibo.it/assets/api.js"></script>

    <!-- Funzioni di supporto -->
    <script src="../../js/function.js"></script>


    <script>
        $.get('../templates/authNav.html', (data) => {
            $('body').append(data)
        })
    </script>

    <script>
        checkToken()
    </script>

</head>

<body>
    <div id="content" class="row">
        <div class="d-flex justify-content-center">
            <h1>Informazioni sul cliente</h1>
        </div>

        <div class="col-sm-6 d-flex justify-content-end">
            <div class="row d-flex justify-content-end">
                <img class="img-fluid rounded" id="profilepicture" style="height: 18em; width: 18em;"><br>
                <textarea id="description" class="mt-3" disabled="disabled"></textarea>
            </div>

        </div>

        <div class="col-sm-6">
            <form id="customerInfo">
                <label for="username">Username: </label><br>
                <input id="username" disabled="disabled"><br>
                <label for="firstname">Nome: </label><br>
                <input id="firstname" disabled="disabled"><br>
                <label for="lastname">Cognome: </label><br>
                <input id="lastname" disabled="disabled"><br>
                <label for="dateOfBirth">Data di nascita: </label><br>
                <input id="dateOfBirth" disabled="disabled"><br>
                <label for="country">Paese: </label><br>
                <input id="country" disabled="disabled"><br>
                <label for="city">Città: </label><br>
                <input id="city" disabled="disabled"><br>
                <label for="streetAddress">Indirizzo: </label><br>
                <input id="streetAddress" disabled="disabled"><br>
                <label for="zipcode">Codice postale: </label><br>
                <input id="zipcode" disabled="disabled"><br>
            </form>
        </div>

        <div id="buttonPanel" class="d-flex justify-content-evenly mt-3">
            <button type="button" class="btn btn-primary" id="modify">Modify</button>
            <div id="wrapperdelete" data-toggle="tooltip"
                title="Non è possibile eliminare un cliente che ha noleggi aperti o chiusi">
                <button type="button" class="btn btn-danger" id="delete">Delete</button>
            </div>
            <button type="button" class="btn btn-warning" id="submit">Submit</button>
        </div>

        <!-- Informazioni su rent pending & aperti -->
        <!-- Informazioni tutti i rent effettuati  -->
        <!-- Info sui prodotti che cerca più frequentemente  ?? -->
        <div id="rentInfo" class="mt-5">
            <div id="pendingRent" class="row">
                <h1>Noleggi in attesa di conferma: </h1>
            </div>
            <div id="openRent" class="row">
                <h1>Noleggi aperti:</h1>
            </div>
            <div id="closeRent" class="row">
                <h1>Noleggi conclusi:</h1>
            </div>
        </div>
    </div>
</body>

<footer>

    <script>
        let customer
        let state = true

        $('document').ready(async () => {

            const idCustomer = localStorage.getItem('idCustomer')
            customer = (await api.customers.getSingle(idCustomer)).data

            let query = {
                paginatorLimit: 0,
                populate: true
            }

            console.log(customer)

            //Aggiungo le info come placeholder del form
            $('#username').attr('value', `${customer.loginInfo.username}`)
            $('#firstname').attr('value', `${customer.firstname}`)
            $('#lastname').attr('value', `${customer.lastname}`)
            $('#dateOfBirth').attr('value', `${(customer.dateOfBirth).toString().slice(0, 10)}`)
            $('#country').attr('value', `${customer.address.country}`)
            $('#city').attr('value', `${customer.address.city}`)
            $('#streetAddress').attr('value', `${customer.address.streetAddress}`)
            $('#zipcode').attr('value', `${customer.address.zipcode}`)

            //Aggiungo altre informazioni dell'utente
            $('#profilepicture').attr('src', `https://site202120.tw.cs.unibo.it/${customer.profilePicture}`)
            $('#description').val(customer.description)

            //Prendo le rent
            let rentals = (await api.customers.getRentals(idCustomer, query)).data.docs
            console.log(rentals)


            let pendingRentals = []
            let openRentals = []
            let closeRentals = []

            rentals.forEach(rent => {
                if (rent.state == 'pending')
                    pendingRentals.push(rent)
                if (rent.state == 'open')
                    openRentals.push(rent)
                if (rent.state == 'close')
                    closeRentals.push(rent)
            });

            if (openRentals.length > 0 || closeRentals.length > 0) {
                $('#delete').addClass('disabled')
            }
            //TODO: formattare le date in modo umano
            pendingRentals.forEach(rent => {
                $('#pendingRent').append(`
                <div class="card col-sm-3 mt-3" onclick="rentalPage('${rent._id}')">
                    <h4>Rent pending di ${rent.unit.name} </h4>
                    <p>Il rent deve partire il ${(new Date(rent.startDate)).toString().slice(0, 16)}</p>
                </div>
                `)
            });

            openRentals.forEach(rent => {
                $('#delete').attr('data-toggle', 'tooltip')
                $('#delete').attr('title', 'horray')
                $('#openRent').append(`
                <div class="card col-sm-3 mt-3" onclick="rentalPage('${rent._id}')">
                    <h4>Rent aperto di ${rent.unit.name}</h4>
                    <p>Il rent è iniziato ${(new Date(rent.startDate)).toString().slice(0, 16)}</p>
                    <p>E deve finire ${(new Date(rent.expectedEndDate)).toString().slice(0, 16)}</p>
                </div>
                `)
            });

            closeRentals.forEach(rent => {
                $('#closeRent').append(`
                <div class="card col-sm-3 mt-3" onclick="rentalPage('${rent._id}')">
                    <h4>Rent chiuso di ${rent.unit.name}</h4>
                    <p>Il rent è iniziato ${(new Date(rent.startDate)).toString().slice(0, 16)}</p>
                    <p>La fine era prevista per ${(new Date(rent.expectedEndDate)).toString().slice(0, 16)}</p>
                    <p>La consegne è effettivamente avvenuta ${(new Date(rent.endDate)).toString().slice(0, 16)}</p>
                </div>
                `)
            });

        })

        function getFormCustomer() {    
            let newCustomer = {
                firstname: $('#firstname').val(),
                lastname: $('#lastname').val(),
                dateOfBirth: $('#dateOfBirth').val(),
                loginInfo: customer.loginInfo,
                address: {
                    city: $('#city').val(),
                    country: $('#country').val(),
                    streetAddress: $('#streetAddress').val(),
                    zipcode: $('#zipcode').val(),
                },
                description: $('#description').val() || "",
                profilePicture: "image/profile/placeholder.png",
                _id: customer._id
            }
            console.log(newCustomer)
            return newCustomer
        }

        $('#modify').click(async () => {
            if (state) {
                $('#username').removeAttr('disabled')
                $('#firstname').removeAttr('disabled')
                $('#lastname').removeAttr('disabled')
                $('#dateOfBirth').removeAttr('disabled')
                $('#country').removeAttr('disabled')
                $('#city').removeAttr('disabled')
                $('#streetAddress').removeAttr('disabled')
                $('#zipcode').removeAttr('disabled')
                $('#description').removeAttr('disabled')

                state = false
                // addSubmit()
            }
            else {
                $('#username').attr('disabled', 'disabled')
                $('#firstname').attr('disabled', 'disabled')
                $('#lastname').attr('disabled', 'disabled')
                $('#dateOfBirth').attr('disabled', 'disabled')
                $('#country').attr('disabled', 'disabled')
                $('#city').attr('disabled', 'disabled')
                $('#streetAddress').attr('disabled', 'disabled')
                $('#zipcode').attr('disabled', 'disabled')
                $('#description').attr('disabled', 'disabled')

                state = true
                // $('#submit').remove()
            }

        })

        //Devo aggiungere un bottone per fare il submit
        function addSubmit() {
            $('#buttonPanel').append(`
            <button id="submit" class="btn btn-warning>Submit</button>
            `)
        }

        $('#delete').on('click', async (event) => {
            event.preventDefault()

            const response = await api.customers.deleteSingle(customer._id, getFormCustomer())
            console.log(response)
        })

        $('#submit').on('click', async (event) => {
            event.preventDefault()

            const response = (await api.customers.patchSingle(customer._id, getFormCustomer())).data
            console.log(response)
        })
    </script>
</footer>

</html>