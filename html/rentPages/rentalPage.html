<!DOCTYPE html>
<html lang="it">

<head>
    <title>ThePrivilege employee stuff</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--Stylesheet -->
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Awesome CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    </script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Richiesta Api dal backend -->
    <script src="https://site202120.tw.cs.unibo.it/assets/config.js"></script>
    <script src="https://site202120.tw.cs.unibo.it/assets/api.js"></script>

    <!-- Funzioni di supporto -->
    <script src="../../js/function.js"></script>

    <script>
        $.get('../templates/authNav.html', (data) => {
            $('body').append(data)
        })

        checkToken()
    </script>

<body>
    <div id="content">
        <div class="card mb-3 p-4" >
            <h1>Informazioni sul noleggio</h1>
            <form class="form ">
                <div class="input-group mb-2">
                    <span class="input-group-text">Nome prodotto: </span><br>
                    <input type="text" disabled="disabled" id="unitname" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Data del noleggio: </span><br>
                    <input type="date" disabled="disabled" id="prenotationdate" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Stato del noleggio: </span><br>
                    <input type="text" disabled="disabled" id="state" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Cliente: </span><br>
                    <input type="text" disabled="disabled" id="customer" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Impiegato: </span><br>
                    <select class="form-select" disabled="disabled" id="employee" class="form-control">
                        <option selected>Il nome dell impiegato</option>
                    </select>
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Data di inizio</span><br>
                    <input type="date" disabled="disabled" id="startdate" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Data fine programmata:</span><br>
                    <input type="date" disabled="disabled" id="expectedenddate" class="form-control">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Data fine effettiva</span><br>
                    <input type="date" disabled="disabled" id="actualstartdate" class="form-control">
                </div>
                <div id="buttonpanel" class="d-flex justify-content-around">
                    <button id="modify" class="btn btn-primary me-2">Modifica</button>
                    <button id="delete" class="btn btn-danger me-2">Elimina</button>
                </div>
            </form>

        </div>

        <div class="card mb-3 p-4">
            <h1>Informazioni sulla bill o sulla price estimation</h1>
        </div>
    </div>


</body>

<footer>
    <script>
        let rental
        let modifyState = true

        //Get del rental e caricamento dei dati nel form
        $(document).ready(async () => {
            let query = { populate: true }
            const idRental = localStorage.getItem('idRental')

            rental = (await api.rentals.getSingle(idRental, query)).data
            console.log(rental)

            $('#unitname').val(rental.unit.name)
            $('#prenotationdate').val((rental.prenotationDate).toString().slice(0, 10))
            $('#state').val(rental.state)
            $('#employee').val(rental.employee.lastname + ' ' + rental.employee.firstname)
            $('#startdate').val((rental.startDate).toString().slice(0, 10))
            $('#expectedenddate').val((rental.expectedEndDate).toString().slice(0, 10))

            //L'effettiva data di termine del noleggio può non essere definita:
            if (rental.actualEndDate)
                $('#actualenddate').val((rental.actualEndDate).toString().slice(0, 10))

            
            $('#employee').append(`
            <option selected value="${rental.employee._id}">${rental.employee.lastname} ${rental.employee.firstname}</option> 
            `)

            //gestione particolare per il customer
            quer = { limit: 1}
            const employees = (await api.employees.get(query)).data.docs
            console.log(employees)
            employees.forEach(employee => {
                $('#employee').append(`
                <option value="${employee._id}"> ${employee.lastname} ${employee.firstname}</option>
                `)
            })
            $('#customer').val(rental.customer.lastname + ' ' + rental.customer.firstname)
        })

        $('#modify').on('click', (event) => {
            event.preventDefault()

            if (modifyState) {
                //Rendo i campi non fondamentali modificabili
                $('#state').removeAttr('disabled')
                $('#employee').removeAttr('disabled')
                $('#startdate').removeAttr('disabled')
                $('#expectedenddate').removeAttr('disabled')
                $('#actualenddate').removeAttr('disabled')
                $('#actualenddate').removeAttr('disabled')

                //Creo il bottone di submit
                $('#buttonpanel').append(`
                    <button id="submit" class="btn btn-success">Conferma</button>
                `)

                //Scrivo la funzione del bottone di submit
                $('#submit').on('click', async (event) => {
                    event.preventDefault()

                    let newRental = rental
                    newRental.customer = rental.customer._id
                    newRental.employee = rental.employee._id
                    newRental.unit = rental.unit._id

                    //Prendo i dati dal form e creo un nuovo rental da quello di partenza
                    newRental.state = $('#state').val()

                    $('#employee')

                    newRental.startDate = $('#startdate').val() + 'T00:00:00.000Z'
                    newRental.expectedEndDate = $('#expectedenddate').val() + 'T00:00:00.000Z'
                    newRental.actualEndDate = $('#actualenddate').val() + 'T00:00:00.000Z'

                    const response = await api.rentals.patchSingle(rental._id, newRental)
                    console.log(resposne)
                    //rimuovo la possibilità di modicare momentaneamente e rimuovo il pulsante di modifica
                })

                modifyState = false
            }
            else {
                // i campi ritornano disabilitati ed il pulsante viene rimosso 
                $('#state').attr('disabled', 'disabled')
                $('#employee').attr('disabled', 'disabled')
                $('#startdate').attr('disabled', 'disabled')
                $('#expectedenddate').attr('disabled', 'disabled')
                $('#actualenddate').attr('disabled', 'disabled')
                $('#actualenddate').attr('disabled', 'disabled')

                $('#submit').remove()

                modifyState = true

            }


            // $('#unitname')
            // $('#prenotationdate')
            // $('#state')
            // $('#customer')
            // $('#employee')
            // $('#startdate')
            // $('#expectedenddate')
            // $('#actualenddate')
            // $('#actualenddate')
        })

    </script>
</footer>

</html>