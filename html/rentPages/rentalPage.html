<!DOCTYPE html>
<html lang="it">

<head>
    <title>ThePrivilege employee stuff</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--Stylesheet -->
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Awesome CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Richiesta Api dal backend -->
    <script src="https://site202120.tw.cs.unibo.it/assets/config.js"></script>
    <script src="https://site202120.tw.cs.unibo.it/assets/api.js"></script>

    <!-- Funzioni di supporto -->
    <script src="../../js/function.js"></script>

    <script>
        $.get('../templates/authNav.html', (data) => {
            $('body').append(data)
        })

        checkToken()
    </script>
</head>

<body>
    <div id="content">
        <div class="d-flex justify-content-center mb-4">
            <h1>Informazioni sul noleggio</h1>
        </div>

        <div class="d-flex justify-content-center">
            <div class="card mb-4 p-4 col-sm-8">
                <form class="form">
                    <div class="input-group mb-2">
                        <span class="input-group-text">Nome prodotto: </span><br>
                        <input type="text" disabled="disabled" id="unitname" class="form-control">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Data del noleggio: </span><br>
                        <input type="date" disabled="disabled" id="prenotationdate" class="form-control">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Stato del noleggio: </span><br>
                        <select id="state" class="form-select" disabled="disabled">
                            <option id="pending" value="pending">In attesa</option>
                            <option id="open" value="open">Aperto</option>
                            <option id="close" value="close">Chiuso</option>
                        </select>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Cliente: </span><br>
                        <input type="text" disabled="disabled" id="customer" class="form-control">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Impiegato: </span><br>
                        <select id="employee" class="form-select" disabled="disabled">
                            <option id="undefined" value="undefined">Nessuno</option>
                        </select>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Data di inizio</span><br>
                        <input type="date" disabled="disabled" id="startdate" class="form-control">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Data fine programmata:</span><br>
                        <input type="date" disabled="disabled" id="expectedenddate" class="form-control">
                    </div>
                    <div class="input-group mb-4">
                        <span class="input-group-text">Data fine effettiva</span><br>
                        <input type="date" disabled="disabled" id="actualenddate" class="form-control">
                    </div>
                    <div id="buttonpanel" class="row d-flex justify-content-center">
                        <button id="modify" class="btn btn-search col-sm-3 me-4 ">Modifica</button>
                        <button id="delete" class="btn btn-search col-sm-3 me-4">Elimina</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="d-flex justify-content-center mb-4">
            <h1>Informazioni sul prezzo</h1>
        </div>

        <div class="d-flex justify-content-center">
            <div id="priceinfo" class="card mb-4 p-4 col-sm-8">
            </div>
        </div>
    </div>
</body>

<footer>
    <script>
        let rental

        $(document).ready(async () => {
            let query = { populate: true }
            const rentalID = localStorage.getItem('rentalID')

            rental = (await api.rentals.getSingle(rentalID, query)).data
            console.log('Il noleggio populate: ')
            console.log(rental)

            query = { limit: 0 }
            const employees = (await api.employees.get(query)).data.docs


            //Inserisco le informazioni nel form
            employees.forEach(employee => {
                $('#employee').append(`
                <option id="${employee._id}" value="${employee._id}">${employee.lastname} ${employee.firstname}</option>
                `)
            });

            $('#unitname').val(rental.unit.name)
            $('#prenotationdate').val((rental.prenotationDate).toString().slice(0, 10))
            $('#customer').val(rental.customer.lastname + ' ' + rental.customer.firstname)
            $('#' + rental.state).attr('selected', 'selected')
            if (rental.employee)
                $('#' + rental.employee._id).attr('selected', 'selected')
            $('#startdate').val((rental.startDate).toString().slice(0, 10))
            $('#expectedenddate').val((rental.expectedEndDate).toString().slice(0, 10))

            if (rental.actualEndDate)
                $('#actualenddate').val((rental.actualEndDate).toString().slice(0, 10))

            if (rental.priceEstimation == undefined) {
                query = { from: rental.startDate, to: rental.expectedEndDate }
                let priceEstimation = (await api.products.priceEstimation(rental.unit.product._id, query)).data
                console.log('priceEstimation')
                console.log(priceEstimation)

                rental.priceEstimation = priceEstimation[0]

                const response = (await api.rentals.patchSingle(rental._id, rental))
                console.log('Risposta alla patch')
                console.log(response)

                document.location.href = "./rentalPage.html"
            }

            if (rental.state == 'close') {
                if (rental.bill == undefined) {
                    let data = {
                        customer: rental.customer._id,
                        employee: rental.employee._id,
                        startRent: rental.startDate,
                        endRent: rental.expectedEndDate,
                        unit: rental.unit._id,
                        modifier: rental.priceEstimation.modifiersList,
                        basePrice: rental.priceEstimation.basePrice,
                        finalPrice: rental.priceEstimation.finalPrice,
                    }
                    let query = {
                        expectedEndDate: rental.expectedEndDate
                    }
                    console.log(data)

                    const response = (await api.bills.post(data, query)).data
                    console.log(response)

                    rental.bill = response._id
                    const patchRental = (await api.rentals.patchSingle(rentalID, rental)).data
                    console.log(patchRental)

                    document.location.href = "./rentalPage.html"
                }
            }

            $('#priceinfo').append(`
                    <p>Noleggio stimato di ${rental.priceEstimation.daysCount} giorni.</p>
                    <p>Prezzo senza sconti ${priceFormat(rental.priceEstimation.basePrice)} €</p>
                    <ul id="modifierslist">
                    </ul>
                `)

            rental.priceEstimation.modifiersList.forEach(modifier => {
                $('#modifierslist').append(`
                        <li>${modifier.longExplanation}</li>
                        `)
            })

            $('#priceinfo').append(`
                    <p>Prezzo finale: ${priceFormat(rental.priceEstimation.finalPrice)} €</p>
                    `)

            if (rental.bill != undefined) {
                $('#priceinfo').append(`
                <div class="d-flex justify-content-center">
                    <button class="btn btn-search" onclick="billPage('${rental.bill._id}')">Vai alla fattura</button>
                </div>
                `)
            }

        })

        //Bottone Modifica
        let modifyState = true
        $('#modify').on('click', (event) => {
            event.preventDefault()

            if (modifyState) {
                //Rendo i campi non fondamentali modificabili {prodotto,cliente, data prenotazione}
                $('#state').removeAttr('disabled')
                $('#employee').removeAttr('disabled')
                $('#startdate').removeAttr('disabled')
                $('#expectedenddate').removeAttr('disabled')
                $('#actualenddate').removeAttr('disabled')

                //Creo il bottone di submit
                $('#buttonpanel').append(`
                <button id="submit" class="btn btn-search col-sm-3">Conferma</button>
                `)

                //Scrivo la funzione del bottone di submit
                $('#submit').on('click', async (event) => {
                    event.preventDefault()

                    //Modifico i campi del rental che ho richiesto e poi lo invio
                    rental.customer = rental.customer._id
                    rental.employee = $('#employee').val()

                    rental.state = $('#state').val()

                    rental.startDate = $('#startdate').val() + 'T00:00:00.000Z'
                    rental.expectedEndDate = $('#expectedenddate').val() + 'T00:00:00.000Z'

                    if ($('#actualenddate').val().includes('-'))
                        rental.actualEndDate = $('#actualenddate').val() + 'T00:00:00.000Z'
                    else
                        rental.actualEndDate = undefined

                    console.log(rental)

                    query = { from: rental.startDate, to: rental.expectedEndDate }
                    let priceEstimation = (await api.products.priceEstimation(rental.unit.product._id, query)).data
                    rental.priceEstimation = priceEstimation[0]

                    //Questo campo lo cambio dopo perché prima devo richiedere la priceEstimation
                    rental.unit = rental.unit._id

                    const response = await api.rentals.patchSingle(rental._id, rental)
                    console.log(response)

                    document.location.href = "./rentalPage.html"
                })

                modifyState = false
            }
            else {
                // i campi ritornano disabilitati ed il pulsante viene rimosso 
                $('#state').attr('disabled', 'disabled')
                $('#employee').attr('disabled', 'disabled')
                $('#startdate').attr('disabled', 'disabled')
                $('#expectedenddate').attr('disabled', 'disabled')
                $('#actualenddate').attr('disabled', 'disabled')

                $('#submit').remove()

                modifyState = true
            }
        })

        //Bottone Delete
        $('#delete').on('click', async (event) => {
            event.preventDefault()

            if (rental.state == 'pending') {
                const response = (await api.rentals.deleteSingle(rental._id)).data
                console.log(response)

                document.location.href = "./rentalsPage.html"
            }
            else{
                window.alert('Non è possibile cancellare un noleggio se lo stato è aperto o chiuso')
            }



        })


    </script>
</footer>

</html>