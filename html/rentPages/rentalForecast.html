<!DOCTYPE html>
<html lang="it">

<head>
    <title>ThePrivilege employee stuff</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--Stylesheet -->
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Awesome CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Richiesta Api dal backend -->
    <script src="https://site202120.tw.cs.unibo.it/assets/config.js"></script>
    <script src="https://site202120.tw.cs.unibo.it/assets/api.js"></script>

    <!-- Funzioni di supporto -->
    <script src="../../js/function.js"></script>

    <script>
        $.get('../templates/authNav.html', (data) => {
            $('body').append(data)
        })

        checkToken()
    </script>
</head>

<body>
    <div id="content">
        <div class="d-flex justify-content-center mb-4 ">
            <h1>Creazione di noleggi</h1>
        </div>

        <div class="card mb-4 p-4">
            <form>
                <div class="input-group mb-2">
                    <span class="input-group-text">Nome prodotto: </span>
                    <select id="productname" class="form-select">
                    </select>
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">Inizio del noleggio: </span>
                    <input type="date" id="startRent" class="form-control">
                </div>
                <div class="input-group mb-4">
                    <span class="input-group-text">Fine del noleggio: </span>
                    <input type="date" id="expectedEndRent" class="form-control">
                </div>
                <div id="buttonpanel">
                    <button id="submit" class="btn btn-search col-sm-3 me-4 ">Verifica Disponibilità</button>
                </div>
            </form>
        </div>

        <div id="searchedProducts" class="card"></div>
    </div>  
</body>

<footer>
    <!-- 
        Qui cerco il prodotto inserito: indico disponibilità, 
        prezzo, la unit interessata, la price estimation, 
        poi rimando alla pagina specifica per la modifica degli altri campi

        Creare un rent lo mette automaticamente open ed associato al employee che l'ha creato ????
        (Di base NO)
    -->
    <script>
        $(document).ready(async() => {
            //Carico tutti i prodotti per il select

            let query = { limit: 0 }
            const products = (await api.products.get(query)).data.docs
            console.log(products)

            products.forEach(product => {
                $('#productname').append(`
                <option value="${product._id}">${product.name}</option>
                `)
            });
            
        })

        $('#submit').on('click', async(event) => {
            event.preventDefault()
            let productID = $('#productname').val()
            let query = {
                from: $('#startRent').val() + 'T00:00:00.000Z',
                to: $('#expectedEndRent').val() + 'T00:00:00.000Z'
            }

            const response = (await api.products.available(productID, query)).data
            console.log(response)

            if(response.available){
                $('#searchedProducts').append(`
                <p>Il prodotto cercato è disponibile </p>
                `)

                const priceEstimation = (await api.products.priceEstimation(productID, query)).data
                console.log(priceEstimation)

                $('#searchedProducts').append(`
                <p>Il prodotto cercato nelle date inserite costa: ${priceEstimation.finalPrice}</p>
                <button class="btn btn-search"> Premi qui se vuoi confermare il rent </button>
                `)
            }
            else{
                $('#searchedProducts').append(`
                <p>Il prodotto cercato non è disponibile in quelle date </p>
                `)
            }
        })
    </script>
</footer>

</html>