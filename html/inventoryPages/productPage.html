<!DOCTYPE html>
<html lang="it">

<head>
    <title>ThePrivilege employee stuff</title>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--Stylesheet -->
    <link rel="stylesheet" href="../../css/style.css">

    <!-- Awesome CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Richiesta Api dal backend -->
    <script src="https://site202120.tw.cs.unibo.it/assets/config.js"></script>
    <script src="https://site202120.tw.cs.unibo.it/assets/api.js"></script>

    <!-- Funzioni di supporto -->
    <script src="../../js/function.js"></script>

    <script>
        $.get('../templates/authNav.html', (data) => {
            $('body').append(data)
        })
        checkToken()
    </script>

</head>

<!-- TODO: Gestire la modifica delle informazioni base, leggera modifica della card, tags, STILE, card dei prodotti alternativi cancellare il prodotto -->

<body>
    <div id="content">
        <div class="d-flex justify-content-center mb-4">
            <h1>Pagina del prodotto</h1>
        </div>

        <div id="basicinfo" class="mb-4">
            <div class="card p-4">
                <div class="row">
                    <div class="col-sm-4">
                        <img id="productimage" class="img-fluid rounded-start mb-2" alt="...">
                        <label id="labelnewproductimage" class="collapse" for="newproductimage">Scegli la nuova immagine</label><br>
                        <input id="newproductimage" name="image" type="file" class="collapse">
                    </div>
                    <div class="col-sm-8">
                        <div class="col-sm-7 mb-2">
                            <input id="name" disabled="disabled" class="form-control input-card title" name="name">
                        </div>
                        <div class="col-sm-7 mb-2">
                            <label for="category">Categoria</label>
                            <input id="category" disabled="disabled" class="form-control input-card title"
                                name="category">
                        </div>
                        <div class="col-sm-7 mb-2">
                            <label for="subcategory">Sottocategoria</label>
                            <input id="subcategory" disabled="disabled" class="form-control input-card title"
                                name="subcategory">
                        </div>
                        <div class="mb-2">
                            <label for="description">Descrizione</label>
                            <textarea id="description" disabled="disabled" class="form-control input-card title"
                                name="description"></textarea>
                        </div>
                    </div>

                    <div id="buttonpanel" class="row">
                        <div class="col-sm-1"></div>
                        <button id="delete" class="btn btn-search col-sm-2">Cancella</button>
                        <div class="col-sm-2"></div>
                        <button id="modify" class="btn btn-search col-sm-2">Modifica</button>
                        <div class="col-sm-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end col-sm-12 mb-4 ">
            <button id="addunits" class="btn btn-search">Aggiungi unit al prodotto</button>
        </div>

        <div id="unitinfo" class="container mb-4"></div>

        <form id="altproductform" class="mb-4">
            <div class="input-group">
                <span class="input-group-text">Scegli un prodotto da aggiungere a quelli alternativi</span>
                <select id="alternative" class="form-select">
                </select>
                <button class="btn btn-search" id="confirmaltproduct">Conferma</button>
            </div>
        </form>

        <div id="altproductsinfo" class="row mb-4"></div>

        <div id="rentinfo" class="row mb-4">
            <div class="d-flex justify-content-center mb-4">
                <h3>Noleggi associati</h3>
            </div>
        </div>

    </div>
</body>

<footer>
    <script>
        //TODO: fare le richieste e non mantenere in memeoria nella pagina
        const ProductID = localStorage.getItem("ProductID");
        let product 

        let altproducts = []
        let units = []
        let rentals

        let bool = true

        async function getProduct(id, query) {
            let product = (await api.products.getSingle(id, query)).data
            return product
        }

        $('#modify').on('click', (event) => {
            event.preventDefault()

            if (bool) {
                $('#name').removeAttr('disabled')
                $('#category').removeAttr('disabled')
                $('#subcategory').removeAttr('disabled')
                $('#description').removeAttr('disabled')
                $('#newproductimage').removeClass('collapse')
                $('#labelnewproductimage').removeClass('collapse')

                //Aggiungo il bottone per la patch
                $('#buttonpanel').append(`
                <button id="confirm" class="btn btn-search col-sm-2">Conferma</button>
                `)

                //Funzione per il bottone
                $('#confirm').on('click', async (event) => {
                    event.preventDefault()

                    product.name = $('#name').val()
                    product.category = $('#category').val()
                    product.subcategory = $('#subcategory').val()
                    product.description = $('#description').val()

                    const response = await api.products.patchSingle(ProductID, product)
                    console.log('Il prodotto cambiato è: ')
                    console.log(response)

                    document.location.href = "./productPage.html"
                })
            }
            else {
                $('#name').attr('disabled', 'disabled')
                $('#category').attr('disabled', 'disabled')
                $('#subcategory').attr('disabled', 'disabled')
                $('#description').attr('disabled', 'disabled')
                $('#newproductimage').addClass('collapse')
                $('#labelnewproductimage').addClass('collapse')

                //Rimuovo il bottone
                $('#confirm').remove()
                //Reimpostare il contenuto effettivo !!
            }

            bool = !bool
        })

        $('#delete').on('click', async (event) => {
            event.preventDefault()
            const response = await api.products.deleteSingle(ProductID)
            console.log(response)

            localStorage.removeItem('ProductID')
            sessionStorage.removeItem('ProductID')
            document.location.href = "./productsPage.html"
        })

        async function deleteAltProducts(index) {
            altproducts.splice(index, 1)

            product.altproducts = altproducts

            const response = (await api.products.patchSingle(ProductID, product))
            console.log(response)

            refreshAltProducts()
        }

        function refreshUnits() {
            console.log('refresh delle units')

            let i = 0
            units.forEach(unit => {
                i++
                $('#unitinfo').append(`
                <div id="${unit._id}" class="row mb-2 card p-1" style="flex-direction:row;">
                    <div class="col-sm-1"></div>
                    <div class="col-sm-2 d-flex align-items-center">Unit n° ${i}</div>
                    <div class="col-sm-3 d-flex align-items-center">Condizione: ${unit.condition}</div>
                    <div class="col-sm-3 d-flex align-items-center">Prezzo: ${unit.price}</div>
                    <button class="col-sm-2 btn btn-search id="deleteunit">Cancella</button>
                    <div class="col-sm-1"></div>
                </div>
                `)
                //TODO: Units non ha delete su api
                $('#deleteunit').on('click', async () => {

                })
            })
        }

        async function refreshAltProducts() {
            console.log('refresh degli alternative products ')
            $('#altproductsinfo').children('div').remove()

            let i = 0
            altproducts.forEach(altprod => {
                $('#altproductsinfo').append(`
                        <div class="card col-sm-3 me-5 mb-3">
                            <div>
                            <img src="https://site202120.tw.cs.unibo.it/${altprod.image}" class="img-thumbnail">
                            </div>
                            <div class="d-flex justify-content-center">
                            <p class="card-text">${altprod.name}</p>
                            </div>
                            <div class="d-flex justify-content-center">
                            <button class="btn btn-search" id="removealtproduct" onClick="deleteAltProducts(${i})">Rimuovi</button>
                            </div>
                        </div>
                    `)
                i++
            })
        }

        $(document).ready(async function () {
            let query = { populate: true }

            // product = await getProduct(ProductID, query)
            // console.log(product)
            product = (await api.products.getSingle(ProductID, query)).data
            console.log(product)

            units = (await api.products.getUnits(ProductID)).data
            console.log('Le units associate: ')
            console.log(units)

            query = { limit: 0 }
            const products = (await api.products.get(query)).data.docs

            product.altproducts.forEach(altprod => {
                products.forEach(prod => {
                    if (prod._id == altprod)
                        altproducts.push(prod)
                })
            })

            query = { product: ProductID, limit: 0, populate: true }
            rentals = (await api.rentals.get(query)).data.docs
            console.log('I rentals associati: ')
            console.log(rentals)

            urlsite = "https://site202120.tw.cs.unibo.it/" + product.image

            //Modifiche al prodotto
            $('#productimage').attr('src', urlsite)
            $('#name').val(product.name)
            $('#category').val(product.category)
            $('#subcategory').val(product.subcategory)
            $('#description').val(product.description)
            document.getElementById('description').style.height = "auto";
            document.getElementById('description').style.height = document.getElementById('description').scrollHeight + "px";
            $('#description').css('resize', 'none')

            //Informazioni sulle unit del prodoto:
            refreshUnits()

            $('#addunits').on('click', async (event) => {
                event.preventDefault()

                //Append in cima con campi dove posso inserire il testo
                $('#unitinfo').prepend(`
                <div id="newUnit" class="row mb-2 card p-2" style="flex-direction:row;">
                    <div class="col-sm-3">
                        <input type="text" class="form-control" id="value" disabled="disabled" placeholder="${product.name}">
                    </div>
                    <div class="col-sm-2">
                        <select class="form-select" id="condition">
                            <option value="broken">Rovinato</option>
                            <option value="major flaw">Leggermente rovinato</option>
                            <option value="minor flaw">Quasi perfetto</option>
                            <option value="perfect">Perfetto </option>
                        </select>
                    </div>
                    <div class="col-sm-3">
                        <input type="text" class="form-control" id="price" placeholder="Prezzo: ">
                    </div>
                    <button id="confirmunit" class="col-sm-2 btn btn-search">Conferma</button>
                    <button id="deleteunitcard" class="col-sm-2 btn btn-search">Cancella</button>
                </div>
                `)

                //rimuovo la card e poi modifico
                $('#deleteunitcard').on('click', () => {
                    $('#newUnit').remove()
                })

                $('#confirmunit').on('click', async () => {
                    let newUnit = {
                        name: product.name,
                        condition: $('#condition').val(),
                        price: $('#price').val(),
                        rentals: []
                    }

                    units.push(newUnit)

                    const response = (await api.units.post(newUnit, product._id)).data
                    console.log(response)

                    $('#unitinfo').children('div').remove()

                    refreshUnits()
                })
            })

            //Informazioni sui rental del prodotto:
            rentals.forEach(rental => {
                let value = 'Nessuno'
                if (rental.state == 'open' || rental.state == 'close')
                    value = rental.employee.lastname + ' ' + rental.employee.firstname
                $('#rentinfo').append(`
                <div class="col-sm-3">
                <div class="card m-2 pe-4 ps-4 pt-4" onclick="rentalPage('${rental._id}')">
                    <h5>Noleggio codice: ${rental._id}</h5>
                    <p>Stato del noleggio: ${rental.state}</p>
                    <p>Noleggiato da ${rental.customer.lastname}, ${rental.customer.firstname}</p>
                    <p>Impiegato associato: ${value}</p>
                </div>
                </div>
                `)
            })

            //Inserisco i prodotti possibili nel select
            products.forEach(prod => {
                $('#alternative').append(`
                <option value="${prod._id}">${prod.name}</option>
                `)
            })

            //Bottone per aggiungere i prodotti alternativi
            $('#confirmaltproduct').on('click', async (event) => {
                event.preventDefault()

                product.altproducts.push($('#alternative').val())
                altproducts.push($('#alternative').val())

                console.log(altproducts)

                const response = (await api.products.patchSingle(product._id, product)).data
                console.log(response)

                refreshAltProducts()
            })

            refreshAltProducts()
        })
    </script>
</footer>

</html>